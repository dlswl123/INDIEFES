<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="art">

	<!-- 앨범정보입력 -->
	<insert id="insert">
		insert into art_info (art_number, art_genre, user_id, team_number,art_title,art_cover,art_pr)
		values (seq_art.nextval,#{art_genre},#{user_id},#{team_number},#{art_title},#{art_cover},#{art_pr})
	</insert>
	<select id="artInfo" resultType="ArtInfoVo">
		select * 
		from art_info
		where art_number = 
		(select max(art_number)
		 from art_info 
		 where team_number = #{team_number})
	</select>
	
	<!-- 팀등록 -->
	<insert id="teamInsert">
		insert into indie_team (team_number, art_team)
		values (seq_team.nextval,#{art_team})
	</insert>
	
	<!-- 팀멤버 등록 -->
	<insert id="memberInsert">
		insert into team_member (member_number, team_number,user_id,team_level,user_nick)
			<if test = "team_level == 0">
				values (seq_member.nextval,seq_team.currval,#{user_id},#{team_level},#{user_nick})
			</if>
			<if test = "team_level == 1">
				values (seq_member.nextval,#{team_number},#{user_id},#{team_level},#{user_nick})
			</if>
	</insert>
	
<!-- 	앨범정보 읽기 -->
	<select id="artRead" resultType="ArtInfoVo">
		select * 
		from art_info
		where art_number = #{art_number}
	</select>
	
<!-- 	앨범정보 수정폼 -->
	<select id="artModify" resultType="ArtInfoVo">
		select * 
		from art_info
		where user_id = #{user_id}
		and art_number = #{art_number}
	</select>
	
<!-- 	앨범 리스트 가져오기 -->
	<select id="artList" resultType="ArtInfoVo">
		select *
		from (select rownum rnum, a.*
		      from (select art.* 
		      		from art_info art
		      <include refid="search"></include>
		      order by art.art_number desc) a)
		where rnum &gt;= #{startRow} and rnum &lt;= #{endRow}
	</select>
	
<!-- 	인디팀 불러오기 -->
	<select id="getIndieTeam" resultType="IndieTeamVo">
		select *
		from indie_team
		order by team_number
	</select>
	
<!-- 	앨범커버 리스트 불러오기 -->
	<select id="getCover" resultType="string">
		select art_cover
		from art_info
		order by art_number desc
	</select>
	
<!-- 	그룹넘버 가져오기 -->
	<select id="getIndieNumber" resultType="integer">
		select team_number
		from team_member
		where user_id = #{user_id}
	</select>
	
<!-- 	그룹이름 가져오기 -->
	<select id="getTeamName" resultType="string">
		select art_team
		from indie_team
		where team_number = #{team_number}
	</select>
<!-- 	그룹정보 읽기 -->
	<select id="memberList" resultType="TeamMemberVo">
		select * 
		from team_member
		where team_number = #{team_number}
	</select>
<!-- 	그룹앨범 리스트 가져오기 -->
	<select id="teamArtList" resultType="ArtInfoVo">
		select *
		from art_info
		where team_number = #{team_number}
		order by reg_art desc
	</select>
	
<!-- 	페이징갯수 -->
	<select id="artCount" resultType="int">
		select count(*) 
		from art_info art
		<include refid="search"></include>
	</select>
	
<!-- 	검색 중복부분 -->
	<sql id="search">
       	<if test="searchType != null">
       		<if test="searchType == 'albumName'">
            	where art_title like '%' || #{keyword} || '%'
   			</if>
	   		<if test="searchType == 'song'">
	   			, music_info m
	            where art.art_number = m.art_number
	            and m.music_title like '%' || #{keyword} || '%'
	   		</if>
	   		<if test="searchType == 'indieTeam'">
	            where art.team_number = (select team_number
	                                     from indie_team i
	                                     where i.art_team like '%' || #{keyword} || '%'
	                                     group by i.team_number)
	   		</if>
	   		<if test="searchType == 'artGenre'">
	   			where art.art_genre like '%' || #{keyword} || '%'
	   		</if>
       	</if>
	</sql>
	
<!-- 	리스트에 노래 가져오기 -->
	<select id="playList" resultType="MusicInfoVo">
		select *
		from music_info
		where music_number in (select music_number
							  from play_list
							  where user_id = #{user_id})
		order by music_number					  
	</select>
<!-- 	플레이 리스트 -->
	<select id="playListInfo" resultType="PlayListVo">
		select * from play_list
		where user_id = #{user_id}
		order by music_number
	</select>
<!-- 	노래 리스트 등록 -->
	<delete id="playInsert">
		insert into play_list(user_id,music_number,play_index)
		values (#{user_id},#{music_number},seq_playlist.nextval);
	</delete>
<!-- 	노래 리스트 삭제 -->
	<delete id="playDelete">
		delete from play_list
		where play_index = #{play_index} 
	</delete>
<!-- 	최신 앨범 -->
	<select id="toDayList" resultType="ArtInfoVo">
		
		select *
		from (select rownum rnum, a.*
		      from (select art.* from art_info art
		      		where art.reg_art > (sysdate-1)
		      order by art.art_number desc) a)
		where rnum &gt;= #{startRow} and rnum &lt;= #{endRow}
	</select>
<!-- 	인기 앨범 -->
	<select id="goodList" resultType="ArtInfoVo">
		select *
		from art_info
		where rownum &lt; 10
		order by good_count desc
	</select>
	<!-- 	페이징갯수 -->
	<select id="toDayCount" resultType="int">
		select count(*) 
		from art_info
		where reg_art > (sysdate-1)
	</select>
</mapper>